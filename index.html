<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #chat-container { width: 90%; max-width: 600px; height: 90vh; border: 1px solid #333; background-color: #1e1e1e; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: flex; flex-direction: column; border-radius: 8px; }
        h2 { text-align: center; padding: 1rem; margin: 0; border-bottom: 1px solid #333; color: #00ff7f; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 0.75rem; max-width: 85%; }
        .username { font-size: 0.8rem; color: #aaa; margin-bottom: 0.2rem; padding-left: 10px; }
        .text { background-color: #333; padding: 0.5rem 1rem; border-radius: 18px; line-height: 1.4; }
        #controls { display: flex; padding: 1rem; border-top: 1px solid #333; gap: 0.5rem; }
        #controls input { flex-grow: 1; padding: 0.75rem; border: 1px solid #444; background-color: #2b2b2b; color: #e0e0e0; border-radius: 20px; }
        #controls button { padding: 0.75rem 1.5rem; border: none; background-color: #007bff; color: white; cursor: pointer; border-radius: 20px; font-weight: bold; }
        #controls button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <div id="chat-container">
        <h2>Global Chat</h2>
        <div id="messages"></div>
        <div id="controls">
            <input type="text" id="username" placeholder="Your name">
            <input type="text" id="message-text" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // ================== YOUR MOST IMPORTANT STEP ==================
        // This MUST be the public URL of your BACKEND server.
        // You must update this every time you restart ngrok.
        // ==============================================================
        const API_URL = "https://c3c423fd6549.ngrok-free.app";

        const messagesDiv = document.getElementById('messages');
        const usernameInput = document.getElementById('username');
        const textInput = document.getElementById('message-text');

        async function fetchMessages() {
            try {
                const response = await fetch(API_URL + '/messages');
                if (!response.ok) { // Check if response is not 2xx
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const messages = await response.json();
                
                let messagesHTML = '';
                messages.slice().reverse().forEach(msg => {
                    messagesHTML += `
                        <div class="message-wrapper">
                            <div class="username">${escapeHTML(msg.username)}</div>
                            <div class="text">${escapeHTML(msg.text)}</div>
                        </div>
                    `;
                });
                messagesDiv.innerHTML = messagesHTML;
            } catch (error) {
                messagesDiv.innerHTML = `<div class="message-wrapper"><div class="text" style="background-color: #ff4444;">Could not connect to server. Is the Python server running, and is the ngrok URL in this code correct?</div></div>`
                console.error("Error fetching messages:", error);
            }
        }

        async function sendMessage() {
            if (!usernameInput.value || !textInput.value) {
                alert('Please enter your name and a message!');
                return;
            }
            await fetch(API_URL + '/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: usernameInput.value, text: textInput.value })
            });
            textInput.value = '';
            fetchMessages();
        }

        // This is the corrected function
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }
        textInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // Check for new messages every 3 seconds
        setInterval(fetchMessages, 3000);
        // Load messages immediately when the page opens
        fetchMessages();
    </script>

</body>
</html>